LÆ°u Ä‘á»“ xuáº¥t Excel

LÆ°u Ä‘á»“ nÃ y mÃ´ táº£ quy trÃ¬nh xuáº¥t dá»¯ liá»‡u sá»©c khá»e ra file Excel. Há»‡ thá»‘ng kiá»ƒm tra xem cÃ³ dá»¯ liá»‡u cáº§n xuáº¥t hay khÃ´ng, sau Ä‘Ã³ táº¡o cÃ¡c dÃ²ng tiÃªu Ä‘á», thÃ´ng tin bá»‡nh nhÃ¢n vÃ  dá»¯ liá»‡u Ä‘o Ä‘Æ°á»£c. Má»—i báº£n ghi sáº½ Ä‘Æ°á»£c xá»­ lÃ½, Ä‘á»‹nh dáº¡ng thá»i gian, tÃ­nh tráº¡ng thÃ¡i sá»©c khá»e vÃ  sáº¯p xáº¿p vÃ o cÃ¡c dÃ²ng dá»¯ liá»‡u. CÃ¡c dÃ²ng nÃ y Ä‘Æ°á»£c káº¿t há»£p vá»›i tiÃªu Ä‘á» Ä‘á»ƒ táº¡o thÃ nh báº£ng dá»¯ liá»‡u hoÃ n chá»‰nh. Há»‡ thá»‘ng thiáº¿t láº­p Ä‘á»™ rá»™ng cá»™t, chiá»u cao dÃ²ng, gá»™p cÃ¡c Ã´ cáº§n thiáº¿t vÃ  Ã¡p dá»¥ng cÃ¡c kiá»ƒu Ä‘á»‹nh dáº¡ng (mÃ u sáº¯c, font chá»¯) cho tá»«ng tráº¡ng thÃ¡i (bÃ¬nh thÆ°á»ng, cáº£nh bÃ¡o, nguy hiá»ƒm). Cuá»‘i cÃ¹ng, file Excel Ä‘Æ°á»£c táº¡o vÃ  táº£i vá» mÃ¡y ngÆ°á»i dÃ¹ng, giÃºp viá»‡c tá»•ng há»£p vÃ  bÃ¡o cÃ¡o dá»¯ liá»‡u sá»©c khá»e trá»Ÿ nÃªn thuáº­n tiá»‡n, trá»±c quan.
LÆ°u Ä‘á»“ chá»n cháº¿ Ä‘á»™ Ä‘o

LÆ°u Ä‘á»“ nÃ y mÃ´ táº£ quy trÃ¬nh khi ngÆ°á»i dÃ¹ng báº¯t Ä‘áº§u Ä‘o cÃ¡c chá»‰ sá»‘ sá»©c khá»e. NgÆ°á»i dÃ¹ng cÃ³ thá»ƒ lá»±a chá»n Ä‘o táº¥t cáº£ cÃ¡c chá»‰ sá»‘ cÃ¹ng lÃºc hoáº·c Ä‘o riÃªng tá»«ng chá»‰ sá»‘ (BPM, SpO2, Nhiá»‡t Ä‘á»™). Há»‡ thá»‘ng kiá»ƒm tra thÃ´ng tin bá»‡nh nhÃ¢n trÆ°á»›c khi báº¯t Ä‘áº§u Ä‘o, Ä‘áº£m báº£o dá»¯ liá»‡u Ä‘áº§u vÃ o há»£p lá»‡. Khi Ä‘o, tráº¡ng thÃ¡i hiá»ƒn thá»‹ sáº½ thay Ä‘á»•i tÆ°Æ¡ng á»©ng (vÃ­ dá»¥: "Äang Ä‘o: Táº¥t cáº£" hoáº·c "Äang Ä‘o: BPM"). Dá»¯ liá»‡u Ä‘o Ä‘Æ°á»£c sáº½ Ä‘Æ°á»£c lÆ°u Ä‘á»‹nh ká»³ lÃªn Firebase, vá»›i cÃ¡c giÃ¡ trá»‹ chÆ°a Ä‘o sáº½ hiá»ƒn thá»‹ lÃ  "-" trong bÃ¡o cÃ¡o Excel. Quy trÃ¬nh nÃ y giÃºp linh hoáº¡t trong viá»‡c theo dÃµi sá»©c khá»e, Ä‘Ã¡p á»©ng nhu cáº§u Ä‘o tá»•ng há»£p hoáº·c Ä‘o riÃªng láº» tá»«ng chá»‰ sá»‘.
# ğŸ“Š LÆ¯U Äá»’ Há»† THá»NG GIÃM SÃT Sá»¨C KHá»E

> **HÆ°á»›ng dáº«n Ä‘á»c lÆ°u Ä‘á»“:**
> - ğŸŸ¦ HÃ¬nh chá»¯ nháº­t: Quy trÃ¬nh/HÃ nh Ä‘á»™ng
> - ğŸ”¶ HÃ¬nh thoi: Äiá»u kiá»‡n/Quyáº¿t Ä‘á»‹nh
> - ğŸŸ¢ HÃ¬nh trÃ²n: Báº¯t Ä‘áº§u/Káº¿t thÃºc
> - â¡ï¸ MÅ©i tÃªn: HÆ°á»›ng luá»“ng dá»¯ liá»‡u

---

## 1. LÆ¯U Äá»’ Tá»”NG QUAN Há»† THá»NG

```mermaid
flowchart TD
    Start([Khá»Ÿi Ä‘á»™ng á»©ng dá»¥ng]) --> InitFirebase[Khá»Ÿi táº¡o Firebase<br/>Config + Auth + Firestore]
    InitFirebase --> RegisterChart[ÄÄƒng kÃ½ Chart.js<br/>Components]
    RegisterChart --> InitStates[Khá»Ÿi táº¡o States<br/>BPM, SpO2, Temp, UI States]
    InitStates --> CheckAuth{Firebase<br/>Auth?}
    
    CheckAuth -->|ChÆ°a Ä‘Äƒng nháº­p| SignInAnon[ÄÄƒng nháº­p áº©n danh<br/>signInAnonymously]
    CheckAuth -->|ÄÃ£ Ä‘Äƒng nháº­p| GetUserID[Láº¥y User ID]
    SignInAnon --> GetUserID
    
    GetUserID --> LoadLocalStorage[Táº£i dá»¯ liá»‡u tá»«<br/>LocalStorage<br/>TÃªn, Tuá»•i, Giá»›i tÃ­nh]
    LoadLocalStorage --> InitCharts[Khá»Ÿi táº¡o 3 biá»ƒu Ä‘á»“<br/>BPM, SpO2, Temp]
    
    InitCharts --> RenderUI[Render giao diá»‡n]
    RenderUI --> WaitInput{Chá» ngÆ°á»i dÃ¹ng<br/>thao tÃ¡c}
    
    WaitInput -->|Nháº­p thÃ´ng tin| UpdatePatientInfo[Cáº­p nháº­t thÃ´ng tin<br/>bá»‡nh nhÃ¢n]
    UpdatePatientInfo --> SaveLocalStorage[LÆ°u vÃ o LocalStorage]
    SaveLocalStorage --> WaitInput
    
    WaitInput -->|Báº¥m Báº¯t Ä‘áº§u Ä‘o| StartMeasurement[Báº¯t Ä‘áº§u phiÃªn Ä‘o]
    WaitInput -->|Chá»n biá»ƒu Ä‘á»“| SwitchChart[Chuyá»ƒn biá»ƒu Ä‘á»“<br/>BPM/SpO2/Temp]
    WaitInput -->|Chá»n ngÃ y| HandleDate[Xá»­ lÃ½ chá»n ngÃ y]
    WaitInput -->|Xuáº¥t Excel| ExportExcel[Xuáº¥t bÃ¡o cÃ¡o Excel]
    
    StartMeasurement --> SetMeasuringTrue[isMeasuring = true<br/>Ghi nháº­n thá»i gian báº¯t Ä‘áº§u]
    SetMeasuringTrue --> StartAnimation[Báº¯t Ä‘áº§u animation<br/>3 biá»ƒu Ä‘á»“]
    StartAnimation --> StartSaving[Báº¯t Ä‘áº§u lÆ°u Firebase<br/>Má»—i 10 giÃ¢y]
    
    SwitchChart --> UpdateActiveChart[Cáº­p nháº­t activeChart]
    UpdateActiveChart --> RenderUI
    
    HandleDate --> CheckDateType{NgÃ y hÃ´m nay?}
    CheckDateType -->|CÃ³| SwitchLiveMode[Cháº¿ Ä‘á»™ Live]
    CheckDateType -->|KhÃ´ng| SwitchHistoricalMode[Cháº¿ Ä‘á»™ Lá»‹ch sá»­]
    
    SwitchLiveMode --> LoadTodayData[Táº£i dá»¯ liá»‡u hÃ´m nay<br/>tá»« Firestore]
    SwitchHistoricalMode --> LoadHistoricalData[Táº£i dá»¯ liá»‡u lá»‹ch sá»­<br/>theo ngÃ y Ä‘Æ°á»£c chá»n]
LÆ°u Ä‘á»“ xá»­ lÃ½ dá»¯ liá»‡u tá»« ESP32 vÃ  hiá»ƒn thá»‹

Dá»¯ liá»‡u tá»« ESP32 Ä‘Æ°á»£c gá»­i vá» qua WebSocket dÆ°á»›i dáº¡ng JSON, bao gá»“m cÃ¡c chá»‰ sá»‘ sá»©c khá»e nhÆ° nhá»‹p tim (BPM), SpO2 vÃ  nhiá»‡t Ä‘á»™. Há»‡ thá»‘ng sáº½ kiá»ƒm tra vÃ  lÃ m sáº¡ch dá»¯ liá»‡u, sau Ä‘Ã³ cáº­p nháº­t cÃ¡c biáº¿n tráº¡ng thÃ¡i vÃ  thá»±c hiá»‡n hiá»‡u á»©ng animation trá»±c quan cho tá»«ng chá»‰ sá»‘. CÃ¡c giÃ¡ trá»‹ nÃ y Ä‘Æ°á»£c hiá»ƒn thá»‹ liÃªn tá»¥c trÃªn giao diá»‡n, Ä‘á»“ng thá»i há»‡ thá»‘ng cÅ©ng kiá»ƒm tra ngÆ°á»¡ng an toÃ n Ä‘á»ƒ cáº£nh bÃ¡o khi phÃ¡t hiá»‡n báº¥t thÆ°á»ng. Náº¿u Ä‘ang trong phiÃªn Ä‘o, dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c lÆ°u Ä‘á»‹nh ká»³ lÃªn Firebase Ä‘á»ƒ phá»¥c vá»¥ theo dÃµi vÃ  xuáº¥t bÃ¡o cÃ¡o.
    
    LoadTodayData --> RenderUI
    LoadHistoricalData --> CreateHistoricalChart[Táº¡o biá»ƒu Ä‘á»“ lá»‹ch sá»­]
    CreateHistoricalChart --> RenderUI
    
    ExportExcel --> CheckData{CÃ³ dá»¯ liá»‡u?}
    CheckData -->|KhÃ´ng| ShowAlert[Hiá»‡n thÃ´ng bÃ¡o lá»—i]
    CheckData -->|CÃ³| FormatExcel[Format dá»¯ liá»‡u Excel<br/>Header + Data + Styles]
    FormatExcel --> DownloadFile[Download file .xlsx]
    DownloadFile --> RenderUI
    ShowAlert --> RenderUI
    
    StartSaving --> CheckConditions{Kiá»ƒm tra Ä‘iá»u kiá»‡n<br/>userId, isMeasuring,<br/>viewMode?}
    CheckConditions -->|KhÃ´ng Ä‘á»§| WaitNext[Chá» chu ká»³ tiáº¿p theo]
    CheckConditions -->|Äá»§ Ä‘iá»u kiá»‡n| SaveToFirestore[LÆ°u vÃ o Firestore<br/>arrayUnion record]
    SaveToFirestore --> UpdateSaveStatus[Cáº­p nháº­t tráº¡ng thÃ¡i<br/>Saved/Error]
    UpdateSaveStatus --> WaitNext
    WaitNext --> StartSaving
    
    style Start fill:#90EE90
    style InitFirebase fill:#87CEEB
    style StartMeasurement fill:#FFD700
    style SaveToFirestore fill:#FF6B6B
    style ExportExcel fill:#9370DB
```

---

## 2. LÆ¯U Äá»’ CHá»ŒN CHáº¾ Äá»˜ Sá»¬ Dá»¤NG

```mermaid
flowchart TD
    Start([NgÆ°á»i dÃ¹ng chá»n ngÃ y<br/>trÃªn Calendar]) --> GetSelectedDate[Láº¥y ngÃ y Ä‘Æ°á»£c chá»n]
    GetSelectedDate --> NormalizeDate[Chuáº©n hÃ³a ngÃ y<br/>vá» midnight local time]
    
    NormalizeDate --> GetToday[Láº¥y ngÃ y hÃ´m nay]
    GetToday --> FormatBoth[Format cáº£ 2 ngÃ y<br/>thÃ nh YYYYMMDD]
    
    FormatBoth --> CompareDates{NgÃ y Ä‘Æ°á»£c chá»n<br/>== HÃ´m nay?}
    
    CompareDates -->|CÃ³| LiveMode[Chuyá»ƒn sang<br/>CHáº¾ Äá»˜ LIVE]
    CompareDates -->|KhÃ´ng| HistoricalMode[Chuyá»ƒn sang<br/>CHáº¾ Äá»˜ Lá»ŠCH Sá»¬]
    
    LiveMode --> SetViewModeLive[viewMode = 'live']
    SetViewModeLive --> CheckFirebase{Firebase<br/>kháº£ dá»¥ng?}
    
    CheckFirebase -->|CÃ³| FetchTodayData[Fetch dá»¯ liá»‡u hÃ´m nay<br/>tá»« Firestore]
    CheckFirebase -->|KhÃ´ng| ShowLiveAlert[Alert: Firebase<br/>Ä‘ang káº¿t ná»‘i]
    
    FetchTodayData --> HasTodayData{CÃ³ dá»¯ liá»‡u<br/>hÃ´m nay?}
    HasTodayData -->|CÃ³| ShowTodayHistory[Hiá»‡n popup<br/>lá»‹ch sá»­ hÃ´m nay]
    HasTodayData -->|KhÃ´ng| PromptStart[Alert: HÃ£y báº¥m<br/>Báº¯t Ä‘áº§u Ä‘o]
    
    ShowTodayHistory --> EnableLiveFeatures[KÃ­ch hoáº¡t tÃ­nh nÄƒng Live:<br/>âœ“ Biá»ƒu Ä‘á»“ real-time<br/>âœ“ NÃºt Báº¯t Ä‘áº§u/Dá»«ng Ä‘o<br/>âœ“ LÆ°u Firebase<br/>âœ“ Xuáº¥t Excel hÃ´m nay]
    PromptStart --> EnableLiveFeatures
    ShowLiveAlert --> EnableLiveFeatures
    
    EnableLiveFeatures --> StartLiveAnimation[Báº¯t Ä‘áº§u animation<br/>3 biá»ƒu Ä‘á»“ live]
    StartLiveAnimation --> DisplayLive[Hiá»ƒn thá»‹:<br/>â€¢ SÃ³ng PPG real-time<br/>â€¢ SpO2 smooth<br/>â€¢ Temp smooth]
    
    HistoricalMode --> SetViewModeHistorical[viewMode = 'historical']
    SetViewModeHistorical --> FormatDocId[Format docId<br/>YYYYMMDD]
    FormatDocId --> FetchHistoricalData[Fetch dá»¯ liá»‡u<br/>tá»« Firestore<br/>theo ngÃ y]
    
    FetchHistoricalData --> HasHistoricalData{CÃ³ dá»¯ liá»‡u<br/>ngÃ y Ä‘Ã³?}
    
    HasHistoricalData -->|CÃ³| ProcessHistoricalData[Xá»­ lÃ½ dá»¯ liá»‡u:<br/>â€¢ records array<br/>â€¢ TÃ­nh avg/min/max]
    HasHistoricalData -->|KhÃ´ng| ShowEmptyMessage[Hiá»‡n: KhÃ´ng cÃ³<br/>dá»¯ liá»‡u ngÃ y nÃ y]
    
    ProcessHistoricalData --> CreateHistoricalChart[Táº¡o biá»ƒu Ä‘á»“ lá»‹ch sá»­<br/>tá»« records]
    CreateHistoricalChart --> DisableLiveFeatures[VÃ´ hiá»‡u hÃ³a:<br/>âœ— NÃºt Báº¯t Ä‘áº§u Ä‘o<br/>âœ— LÆ°u Firebase<br/>âœ— Animation real-time]
    
    DisableLiveFeatures --> EnableHistoricalFeatures[KÃ­ch hoáº¡t:<br/>âœ“ NÃºt Xuáº¥t Excel<br/>âœ“ Hiá»‡n lá»‹ch sá»­ chi tiáº¿t<br/>âœ“ Biá»ƒu Ä‘á»“ static]
    
Lifecycle App React

Quy trÃ¬nh hoáº¡t Ä‘á»™ng cá»§a á»©ng dá»¥ng React báº¯t Ä‘áº§u tá»« khi component Ä‘Æ°á»£c mount lÃªn, khá»Ÿi táº¡o cÃ¡c state vÃ  ref cáº§n thiáº¿t, sau Ä‘Ã³ táº£i dá»¯ liá»‡u ngÆ°á»i dÃ¹ng tá»« LocalStorage vÃ  thá»±c hiá»‡n xÃ¡c thá»±c vá»›i Firebase. Khi xÃ¡c thá»±c thÃ nh cÃ´ng, há»‡ thá»‘ng sáº½ láº¥y User ID, khá»Ÿi táº¡o cÃ¡c biá»ƒu Ä‘á»“ vÃ  Ä‘Äƒng kÃ½ cÃ¡c listener (WebSocket, sá»± kiá»‡n bÃ n phÃ­m, thay Ä‘á»•i kÃ­ch thÆ°á»›c cá»­a sá»•). á»¨ng dá»¥ng luÃ´n láº¯ng nghe cÃ¡c tÆ°Æ¡ng tÃ¡c cá»§a ngÆ°á»i dÃ¹ng nhÆ° nháº­p liá»‡u, chá»n ngÃ y, chá»n biá»ƒu Ä‘á»“, hoáº·c xuáº¥t bÃ¡o cÃ¡o. Má»—i thay Ä‘á»•i sáº½ cáº­p nháº­t láº¡i state, lÆ°u vÃ o LocalStorage vÃ  render láº¡i giao diá»‡n. Khi component bá»‹ unmount, cÃ¡c listener vÃ  timer sáº½ Ä‘Æ°á»£c dá»n dáº¹p Ä‘á»ƒ Ä‘áº£m báº£o hiá»‡u nÄƒng vÃ  trÃ¡nh rÃ² rá»‰ bá»™ nhá»›.
    ShowEmptyMessage --> DisableLiveFeatures
    
    EnableHistoricalFeatures --> DisplayHistorical[Hiá»ƒn thá»‹:<br/>â€¢ Biá»ƒu Ä‘á»“ tÄ©nh<br/>â€¢ Dá»¯ liá»‡u Ä‘Ã£ lÆ°u<br/>â€¢ Thá»‘ng kÃª]
    
    DisplayLive --> End([Káº¿t thÃºc<br/>ÄÃ£ chuyá»ƒn cháº¿ Ä‘á»™])
    DisplayHistorical --> End
    
    style Start fill:#90EE90
    style LiveMode fill:#FFD700
    style HistoricalMode fill:#87CEEB
    style EnableLiveFeatures fill:#98FB98
    style EnableHistoricalFeatures fill:#B0C4DE
    style End fill:#FF6B6B
```

---

## 3. LÆ¯U Äá»’ CHÆ¯Æ NG TRÃŒNH ÄO CHá»ˆ Sá» Sá»¨C KHá»E

### 3.1. LÆ°u Ä‘á»“ chá»n cháº¿ Ä‘á»™ Ä‘o

```mermaid
flowchart TD
    Start([NgÆ°á»i dÃ¹ng muá»‘n Ä‘o]) --> CheckMode{Chá»n cháº¿ Ä‘á»™ Ä‘o?}
    
    CheckMode -->|Äo táº¥t cáº£| StartAll[Báº¥m nÃºt<br/>'Báº¯t Ä‘áº§u Ä‘o' chung]
    CheckMode -->|Äo riÃªng| SelectIndividual{Chá»n chá»‰ sá»‘ nÃ o?}
    
    SelectIndividual -->|BPM| StartBPM[Báº¥m nÃºt 'Äo'<br/>trÃªn card BPM]
    SelectIndividual -->|SpO2| StartSPO2[Báº¥m nÃºt 'Äo'<br/>trÃªn card SpO2]
    SelectIndividual -->|Nhiá»‡t Ä‘á»™| StartTemp[Báº¥m nÃºt 'Äo'<br/>trÃªn card Nhiá»‡t Ä‘á»™]
    
    StartAll --> ValidateAll{ÄÃ£ nháº­p tÃªn<br/>bá»‡nh nhÃ¢n?}
    StartBPM --> ValidateBPM{ÄÃ£ nháº­p tÃªn<br/>bá»‡nh nhÃ¢n?}
    StartSPO2 --> ValidateSPO2{ÄÃ£ nháº­p tÃªn<br/>bá»‡nh nhÃ¢n?}
    StartTemp --> ValidateTemp{ÄÃ£ nháº­p tÃªn<br/>bá»‡nh nhÃ¢n?}
    
    ValidateAll -->|KhÃ´ng| ShowAlert1[Alert: Nháº­p tÃªn trÆ°á»›c!]
    ValidateBPM -->|KhÃ´ng| ShowAlert2[Alert: Nháº­p tÃªn trÆ°á»›c!]
    ValidateSPO2 -->|KhÃ´ng| ShowAlert3[Alert: Nháº­p tÃªn trÆ°á»›c!]
    ValidateTemp -->|KhÃ´ng| ShowAlert4[Alert: Nháº­p tÃªn trÆ°á»›c!]
    
    ShowAlert1 --> End1([Káº¿t thÃºc])
    ShowAlert2 --> End1
    ShowAlert3 --> End1
    ShowAlert4 --> End1
    
    ValidateAll -->|CÃ³| SetAllMeasuring[Set isMeasuring = true<br/>Táº¯t cÃ¡c Ä‘o riÃªng<br/>Ghi thá»i gian báº¯t Ä‘áº§u]
    ValidateBPM -->|CÃ³| SetBPMMeasuring[Set isMeasuringBpm = true<br/>Ghi thá»i gian báº¯t Ä‘áº§u]
    ValidateSPO2 -->|CÃ³| SetSPO2Measuring[Set isMeasuringSpo2 = true<br/>Ghi thá»i gian báº¯t Ä‘áº§u]
    ValidateTemp -->|CÃ³| SetTempMeasuring[Set isMeasuringTemp = true<br/>Ghi thá»i gian báº¯t Ä‘áº§u]
    
    SetAllMeasuring --> MeasureAll[Äo cáº£ 3 chá»‰ sá»‘:<br/>BPM + SpO2 + Nhiá»‡t Ä‘á»™]
    SetBPMMeasuring --> MeasureBPM[Chá»‰ Ä‘o BPM<br/>SpO2, Temp = 0]
    SetSPO2Measuring --> MeasureSPO2[Chá»‰ Ä‘o SpO2<br/>BPM, Temp = 0]
    SetTempMeasuring --> MeasureTemp[Chá»‰ Ä‘o Nhiá»‡t Ä‘á»™<br/>BPM, SpO2 = 0]
    
    MeasureAll --> DisplayStatus1[Hiá»‡n: ğŸ”´ Äang Ä‘o: Táº¥t cáº£]
    MeasureBPM --> DisplayStatus2[Hiá»‡n: ğŸ”´ Äang Ä‘o: ğŸ’“ BPM]
    MeasureSPO2 --> DisplayStatus3[Hiá»‡n: ğŸ”´ Äang Ä‘o: ğŸ« SpO2]
    MeasureTemp --> DisplayStatus4[Hiá»‡n: ğŸ”´ Äang Ä‘o: ğŸŒ¡ï¸ Nhiá»‡t Ä‘á»™]
    
    DisplayStatus1 --> SaveLoop[VÃ²ng láº·p lÆ°u Firebase<br/>Má»—i 10 giÃ¢y]
    DisplayStatus2 --> SaveLoop
    DisplayStatus3 --> SaveLoop
    DisplayStatus4 --> SaveLoop
    
    SaveLoop --> CheckData{CÃ³ Ã­t nháº¥t 1<br/>giÃ¡ trá»‹ > 0?}
    CheckData -->|CÃ³| SaveToFirestore[LÆ°u vÃ o Firebase<br/>GiÃ¡ trá»‹ = 0 â†’ xuáº¥t "-"]
    CheckData -->|KhÃ´ng| WaitNext[Chá» chu ká»³ tiáº¿p]
    
    SaveToFirestore --> ShowSaved[Hiá»‡n icon âœ…<br/>ÄÃ£ lÆ°u]
    ShowSaved --> WaitNext
    WaitNext --> SaveLoop
    
    style Start fill:#90EE90
    style SetAllMeasuring fill:#FFD700
    style SetBPMMeasuring fill:#FF6B6B
    style SetSPO2Measuring fill:#00BFFF
    style SetTempMeasuring fill:#FFA500
    style SaveToFirestore fill:#9370DB
```

### 3.2. LÆ°u Ä‘á»“ xá»­ lÃ½ dá»¯ liá»‡u tá»« ESP32 vÃ  hiá»ƒn thá»‹

```mermaid
flowchart TD
    Start([WebSocket káº¿t ná»‘i ESP32]) --> ReceiveData[Nháº­n dá»¯ liá»‡u JSON:<br/>bpm, spo2, temp]
    
    ReceiveData --> ValidateData[Kiá»ƒm tra vÃ  sanitize:<br/>NaN hoáº·c < 0 â†’ set = 0]
    ValidateData --> UpdateRefs[Cáº­p nháº­t refs:<br/>bpmRef, targetSpo2, targetTemp]
    
    UpdateRefs --> StartAnimations[3 animation loops song song]
    
    StartAnimations --> AnimBPM[Animation BPM:<br/>Váº½ sÃ³ng PPG<br/>Systolic + Dicrotic notch<br/>HRV variation]
    StartAnimations --> AnimSpO2[Animation SpO2:<br/>LERP smooth 2%<br/>Respiratory variation<br/>Sensor noise]
    StartAnimations --> AnimTemp[Animation Nhiá»‡t Ä‘á»™:<br/>LERP smooth 1%<br/>Thermal variation<br/>Circadian rhythm]
    
    AnimBPM --> UpdateChartBPM[Cáº­p nháº­t biá»ƒu Ä‘á»“ BPM<br/>280 Ä‘iá»ƒm]
    AnimSpO2 --> UpdateChartSpO2[Cáº­p nháº­t biá»ƒu Ä‘á»“ SpO2<br/>280 Ä‘iá»ƒm]
    AnimTemp --> UpdateChartTemp[Cáº­p nháº­t biá»ƒu Ä‘á»“ Nhiá»‡t Ä‘á»™<br/>280 Ä‘iá»ƒm]
    
    UpdateChartBPM --> CheckStatusBPM{60-100?}
    UpdateChartSpO2 --> CheckStatusSpO2{>= 95%?}
    UpdateChartTemp --> CheckStatusTemp{35-37Â°C?}
    
    CheckStatusBPM -->|CÃ³| NormalBPM[âœ… BÃ¬nh thÆ°á»ng]
    CheckStatusBPM -->|KhÃ´ng| AlertBPM[âš ï¸ Cáº£nh bÃ¡o/Nguy hiá»ƒm]
    
    CheckStatusSpO2 -->|CÃ³| NormalSpO2[âœ… BÃ¬nh thÆ°á»ng]
    CheckStatusSpO2 -->|KhÃ´ng| AlertSpO2[âš ï¸ SpO2 tháº¥p]
    
    CheckStatusTemp -->|CÃ³| NormalTemp[âœ… BÃ¬nh thÆ°á»ng]
    CheckStatusTemp -->|KhÃ´ng| AlertTemp[âš ï¸ Háº¡ nhiá»‡t/Sá»‘t]
    
    NormalBPM --> DisplayUI[Hiá»ƒn thá»‹ trÃªn UI]
    AlertBPM --> DisplayUI
    NormalSpO2 --> DisplayUI
    AlertSpO2 --> DisplayUI
    NormalTemp --> DisplayUI
    AlertTemp --> DisplayUI
    
    DisplayUI --> CheckMeasuring{Äang Ä‘o?}
    CheckMeasuring -->|CÃ³| CallSaveFirebase[Gá»i saveToFirestore<br/>throttle 10s]
    CheckMeasuring -->|KhÃ´ng| ContinueLoop[Tiáº¿p tá»¥c animation]
    
    CallSaveFirebase --> ContinueLoop
    ContinueLoop --> ReceiveData
    
    style Start fill:#90EE90
    style AnimBPM fill:#FF6B6B
    style AnimSpO2 fill:#00BFFF
    style AnimTemp fill:#FFA500
    style CallSaveFirebase fill:#9370DB
```

### 3.3. LÆ°u Ä‘á»“ lÆ°u dá»¯ liá»‡u Firebase (Chung cho táº¥t cáº£)

```mermaid
flowchart TD
    Start([HÃ m saveToFirestore<br/>Ä‘Æ°á»£c gá»i]) --> CheckConditions{Kiá»ƒm tra Ä‘iá»u kiá»‡n:<br/>userId? db?<br/>viewMode = live?<br/>Äang Ä‘o gÃ¬?}
    
    CheckConditions -->|Thiáº¿u| Return1([Return<br/>KhÃ´ng lÆ°u])
    
    CheckConditions -->|Äá»§| CheckThrottle{< 10s tá»«<br/>láº§n lÆ°u trÆ°á»›c?}
    CheckThrottle -->|CÃ³| Return2([Return<br/>Throttle])
    
    CheckThrottle -->|KhÃ´ng| GetValues[Láº¥y giÃ¡ trá»‹:<br/>bpm, spo2, temp<br/>name, age, gender]
    
    GetValues --> CreateRecord[Táº¡o record object<br/>vá»›i timestamp]
    CreateRecord --> BuildPath[Build Firestore path:<br/>users/userId/health_data/<br/>YYYYMMDD]
    
    BuildPath --> SetStatusSaving[setSaveStatus = 'saving'<br/>Hiá»‡n icon ğŸ”„]
    SetStatusSaving --> TrySetDoc[Try: setDoc<br/>arrayUnion record]
    
    TrySetDoc --> CheckSuccess{Success?}
    
    CheckSuccess -->|CÃ³| ShowSuccess[setSaveStatus = 'saved'<br/>Hiá»‡n âœ… 3 giÃ¢y<br/>recordsSavedToday++]
    CheckSuccess -->|KhÃ´ng| ShowError[setSaveStatus = 'error'<br/>Hiá»‡n âŒ 5 giÃ¢y]
    
    ShowSuccess --> End([Káº¿t thÃºc])
    ShowError --> End
    
    style Start fill:#90EE90
    style CheckConditions fill:#FFD700
    style TrySetDoc fill:#9370DB
    style ShowSuccess fill:#98FB98
    style ShowError fill:#FF6B6B
```

---

## 4. LÆ¯U Äá»’ CHÆ¯Æ NG TRÃŒNH APP

### 4.1. Lifecycle App React

```mermaid
flowchart TD
    Start([Component Mount]) --> InitState[Khá»Ÿi táº¡o States:<br/>â€¢ useState hooks<br/>â€¢ useRef hooks]
    InitState --> LoadLocal[useEffect: Load<br/>LocalStorage<br/>patientName, age, gender]
    
    LoadLocal --> InitFirebase[useEffect: Firebase<br/>Authentication]
    InitFirebase --> CheckAuth{Auth ready?}
    
    CheckAuth -->|KhÃ´ng| RetryAuth[Retry sau 1s]
    RetryAuth --> InitFirebase
    CheckAuth -->|CÃ³| SignIn[signInAnonymously]
    
    SignIn --> OnAuthChanged[onAuthStateChanged<br/>listener]
    OnAuthChanged --> GetUID[Láº¥y User ID]
    GetUID --> SetUserState[setUserId state]
    
    SetUserState --> InitCharts[useEffect: Khá»Ÿi táº¡o<br/>3 biá»ƒu Ä‘á»“]
    InitCharts --> CreateBPMData[createInitialChartData<br/>type: bpm]
    InitCharts --> CreateSpO2Data[createInitialChartData<br/>type: spo2]
    InitCharts --> CreateTempData[createInitialChartData<br/>type: temp]
    
    CreateBPMData --> SetChartStates[Set 3 chart states:<br/>bpmChartData<br/>spo2ChartData<br/>tempChartData]
    CreateSpO2Data --> SetChartStates
    CreateTempData --> SetChartStates
    
    SetChartStates --> RegisterListeners[ÄÄƒng kÃ½ listeners:<br/>â€¢ WebSocket giáº£ láº­p<br/>â€¢ Keyboard events<br/>â€¢ Window resize]
    
    RegisterListeners --> FirstRender[Render láº§n Ä‘áº§u]
    FirstRender --> WaitInteraction[Chá» tÆ°Æ¡ng tÃ¡c<br/>ngÆ°á»i dÃ¹ng]
    
    WaitInteraction --> UserAction{User action?}
    
    UserAction -->|Input thay Ä‘á»•i| HandleInput[Handle input change<br/>onChange event]
    HandleInput --> UpdateState[Cáº­p nháº­t state]
    UpdateState --> SaveToLocal[LÆ°u LocalStorage]
    SaveToLocal --> ReRender[Re-render component]
    
    UserAction -->|Click button| HandleClick[Handle button click<br/>onClick event]
    HandleClick --> CallFunction[Gá»i function tÆ°Æ¡ng á»©ng:<br/>â€¢ startMeasurement<br/>â€¢ stopMeasurement<br/>â€¢ exportToCSV<br/>â€¢ handleDateSelect]
    
    CallFunction --> UpdateStates[Cáº­p nháº­t states]
    UpdateStates --> TriggerEffect[Trigger useEffect<br/>dependencies changed]
    TriggerEffect --> ReRender
    
    UserAction -->|Select chart| HandleChartSelect[handleChartSelect<br/>type: bpm/spo2/temp]
    HandleChartSelect --> SetActiveChart[setActiveChart state]
    SetActiveChart --> ResetChartData[Reset chart data<br/>cho chart Ä‘Ã£ chá»n]
    ResetChartData --> ReRender
    
    UserAction -->|Select date| HandleDateSelect[handleDateSelect<br/>date object]
    HandleDateSelect --> NormalizeDate[Normalize date<br/>to midnight]
    NormalizeDate --> CompareToday{Is today?}
    
    CompareToday -->|CÃ³| SwitchLive[setViewMode live]
    CompareToday -->|KhÃ´ng| SwitchHistorical[setViewMode historical]
    
    SwitchLive --> FetchToday[Fetch today data<br/>from Firestore]
    SwitchHistorical --> FetchHistory[Fetch historical data<br/>from Firestore]
    
    FetchToday --> ProcessData[Process data]
    FetchHistory --> ProcessData
    ProcessData --> UpdateChartData[Update chart data]
    UpdateChartData --> ReRender
    
    ReRender --> WaitInteraction
    
    WaitInteraction --> Unmount{Component<br/>unmount?}
    Unmount -->|CÃ³| Cleanup[Cleanup:<br/>â€¢ cancelAnimationFrame<br/>â€¢ unsubscribe listeners<br/>â€¢ clear intervals]
    Cleanup --> End([Component Unmounted])
    
    Unmount -->|KhÃ´ng| WaitInteraction
    
    style Start fill:#90EE90
    style InitFirebase fill:#FFD700
    style FirstRender fill:#87CEEB
    style ReRender fill:#B0C4DE
    style Cleanup fill:#FF6B6B
    style End fill:#8B0000
```

### 4.2. Xá»­ lÃ½ lÆ°u dá»¯ liá»‡u Firebase

```mermaid
flowchart TD
    Start([saveToFirestore<br/>Ä‘Æ°á»£c gá»i]) --> CheckUserId{userId<br/>tá»“n táº¡i?}
    
    CheckUserId -->|KhÃ´ng| LogWarning1[Console log:<br/>KhÃ´ng cÃ³ userId]
    LogWarning1 --> Return1([Return early])
    
    CheckUserId -->|CÃ³| CheckDB{db<br/>kháº£ dá»¥ng?}
    CheckDB -->|KhÃ´ng| LogWarning2[Console log:<br/>Firebase chÆ°a init]
    LogWarning2 --> Return2([Return early])
    
    CheckDB -->|CÃ³| CheckViewMode{viewMode<br/>== live?}
    CheckViewMode -->|KhÃ´ng| LogWarning3[Console log:<br/>KhÃ´ng á»Ÿ live mode]
    LogWarning3 --> Return3([Return early])
    
    CheckViewMode -->|CÃ³| CheckMeasuring{isMeasuring<br/>== true?}
    CheckMeasuring -->|KhÃ´ng| LogWarning4[Console log:<br/>ChÆ°a báº¯t Ä‘áº§u Ä‘o]
    LogWarning4 --> Return4([Return early])
    
    CheckMeasuring -->|CÃ³| CheckThrottle[TÃ­nh time since<br/>last save]
    CheckThrottle --> IsThrottled{< 10 giÃ¢y?}
    
    IsThrottled -->|CÃ³| LogThrottle[Console log:<br/>Throttle X giÃ¢y ná»¯a]
    LogThrottle --> Return5([Return early])
    
    IsThrottled -->|KhÃ´ng| UpdateLastSave[lastSaveTimeRef<br/>= now]
    UpdateLastSave --> SetStatusSaving[setSaveStatus<br/>saving]
    
    SetStatusSaving --> CreateRecord[Táº¡o newRecord object:<br/>â€¢ timestamp: now<br/>â€¢ bpm: value<br/>â€¢ spo2: value<br/>â€¢ temp: value<br/>â€¢ patientName<br/>â€¢ patientAge<br/>â€¢ patientGender]
    
    CreateRecord --> FormatDocId[Format docId:<br/>YYYYMMDD]
    FormatDocId --> BuildPath[Build Firestore path:<br/>artifacts/appId/users/<br/>userId/health_data/docId]
    
    BuildPath --> GetDocRef[doc db, path]
    GetDocRef --> TrySetDoc[Try: setDoc]
    
    TrySetDoc --> ArrayUnion[arrayUnion<br/>newRecord vÃ o<br/>records array]
    ArrayUnion --> MergeTrue[Option:<br/>merge: true]
    
    MergeTrue --> AwaitSetDoc[await setDoc]
    AwaitSetDoc --> CheckResult{Success?}
    
    CheckResult -->|CÃ³| LogSuccess[Console log:<br/>âœ… LÆ°u thÃ nh cÃ´ng]
    LogSuccess --> SetStatusSaved[setSaveStatus<br/>saved]
    SetStatusSaved --> UpdateLastTime[setLastSavedTime<br/>new Date]
    UpdateLastTime --> IncrementCounter[recordsSavedToday++]
    IncrementCounter --> SetTimeout[setTimeout 3s<br/>reset status to waiting]
    SetTimeout --> Return6([Return success])
    
    CheckResult -->|KhÃ´ng| CatchError[Catch error]
    CatchError --> LogError[Console error:<br/>âŒ Lá»—i lÆ°u]
    LogError --> SetStatusError[setSaveStatus<br/>error]
    SetStatusError --> SetTimeout2[setTimeout 5s<br/>reset status to waiting]
    SetTimeout2 --> Return7([Return error])
    
    style Start fill:#90EE90
    style CheckUserId fill:#FFD700
    style CheckDB fill:#FFD700
    style CheckViewMode fill:#FFD700
    style CheckMeasuring fill:#FFD700
    style CheckThrottle fill:#FFA500
    style CreateRecord fill:#87CEEB
    style AwaitSetDoc fill:#9370DB
    style LogSuccess fill:#98FB98
    style CatchError fill:#FF6B6B
```

### 4.3. Xá»­ lÃ½ xuáº¥t Excel

```mermaid
flowchart TD
    Start([exportToCSV<br/>Ä‘Æ°á»£c gá»i]) --> CheckRecords{records.length<br/>> 0?}
    
    CheckRecords -->|KhÃ´ng| ShowAlert[alert: KhÃ´ng cÃ³<br/>dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t]
    ShowAlert --> End1([Return])
    
    CheckRecords -->|CÃ³| CountPatients[Äáº¿m sá»‘ bá»‡nh nhÃ¢n:<br/>new Set patientName]
    CountPatients --> CreateHeader[Táº¡o header rows:<br/>â€¢ TiÃªu Ä‘á» bÃ¡o cÃ¡o<br/>â€¢ TÃªn cÆ¡ sá»Ÿ<br/>â€¢ NgÃ y xuáº¥t<br/>â€¢ Tá»•ng sá»‘<br/>â€¢ Cá»™t headers]
    
    CreateHeader --> MapRecords[Map records thÃ nh<br/>data rows]
    MapRecords --> ForEachRecord[For each record:]
    
    ForEachRecord --> ExtractData[Extract:<br/>â€¢ patientName<br/>â€¢ patientGender<br/>â€¢ patientAge<br/>â€¢ timestamp<br/>â€¢ bpm, spo2, temp]
    
    ExtractData --> FormatTime[Format timestamp:<br/>toLocaleString vi-VN]
    FormatTime --> CalcStatus[TÃ­nh tráº¡ng thÃ¡i:<br/>getStatusText<br/>bpm, spo2, temp]
    
    CalcStatus --> CreateRow[Táº¡o array row:<br/>name, gender, age,<br/>time, bpm, spo2,<br/>temp, status]
    
    CreateRow --> NextRecord{CÃ²n record?}
    NextRecord -->|CÃ³| ForEachRecord
    NextRecord -->|KhÃ´ng| CombineData[Combine:<br/>header + data rows]
    
    CombineData --> CreateWorksheet[XLSX.utils.aoa_to_sheet<br/>array of arrays]
    CreateWorksheet --> SetColWidths[Set column widths:<br/>!cols property]
    SetColWidths --> SetRowHeights[Set row heights:<br/>!rows property]
    
    SetRowHeights --> CreateMerges[Táº¡o merge cells:<br/>â€¢ Title row<br/>â€¢ Subtitle row<br/>â€¢ Info rows<br/>â€¢ Patient names]
    
    CreateMerges --> ApplyMerges[ws !merges<br/>= merges array]
    ApplyMerges --> DefineStyles[Define styles:<br/>â€¢ titleStyle<br/>â€¢ headerStyle<br/>â€¢ dataStyle<br/>â€¢ warningStyle<br/>â€¢ criticalStyle]
    
    DefineStyles --> ApplyHeaderStyles[Apply styles<br/>cho header rows<br/>rows 1-5]
    
    ApplyHeaderStyles --> LoopDataRows[Loop qua data rows<br/>tá»« row 6]
    LoopDataRows --> CalcRowStatus[TÃ­nh status tá»«<br/>bpm, spo2, temp:<br/>normal/warning/critical]
    
    CalcRowStatus --> ChooseStyle{Status?}
    ChooseStyle -->|critical| UseCriticalStyle[rowStyle =<br/>criticalStyle<br/>Ä‘á» nháº¡t, chá»¯ Ä‘áº­m]
    ChooseStyle -->|warning| UseWarningStyle[rowStyle =<br/>warningStyle<br/>vÃ ng nháº¡t]
    ChooseStyle -->|normal| UseNormalStyle[rowStyle =<br/>dataStyle/Alt<br/>xen káº½ tráº¯ng/xÃ¡m]
    
    UseCriticalStyle --> ApplyCellStyles[Apply style cho<br/>tá»«ng cell A-H]
    UseWarningStyle --> ApplyCellStyles
    UseNormalStyle --> ApplyCellStyles
    
    ApplyCellStyles --> NextDataRow{CÃ²n row?}
    NextDataRow -->|CÃ³| LoopDataRows
    NextDataRow -->|KhÃ´ng| CreateWorkbook[XLSX.utils.book_new]
    
    CreateWorkbook --> AppendSheet[book_append_sheet<br/>ws, Dá»¯ liá»‡u sá»©c khá»e]
    AppendSheet --> WriteFile[XLSX.writeFile<br/>workbook, filename]
    
    WriteFile --> TriggerDownload[Browser trigger<br/>download file .xlsx]
    TriggerDownload --> End2([Return success])
    
    style Start fill:#90EE90
    style CreateHeader fill:#87CEEB
    style DefineStyles fill:#FFA500
    style ApplyCellStyles fill:#9370DB
    style WriteFile fill:#FFD700
    style TriggerDownload fill:#98FB98
    style End2 fill:#98FB98
```

---

## 5. LÆ¯U Äá»’ Xá»¬ LÃ ALERT VÃ€ Cáº¢NH BÃO

```mermaid
flowchart TD
    Start([useEffect triggered<br/>bpm, spo2, temp changed]) --> CheckViewMode{viewMode<br/>== live?}
    
    CheckViewMode -->|KhÃ´ng| Skip[Skip alert check<br/>chá»‰ check á»Ÿ live mode]
    Skip --> End1([Return])
    
    CheckViewMode -->|CÃ³| InitAlerts[alerts = array rá»—ng]
    InitAlerts --> CheckBPM{BPM > 100<br/>hoáº·c < 60?}
    
    CheckBPM -->|CÃ³| AddBPMAlert[alerts.push<br/>Nhá»‹p tim báº¥t thÆ°á»ng: X BPM]
    CheckBPM -->|KhÃ´ng| CheckSpO2{SpO2 < 95%?}
    AddBPMAlert --> CheckSpO2
    
    CheckSpO2 -->|CÃ³| AddSpO2Alert[alerts.push<br/>SpO2 tháº¥p: X%]
    CheckSpO2 -->|KhÃ´ng| CheckTempLow{Temp < 35Â°C?}
    AddSpO2Alert --> CheckTempLow
    
    CheckTempLow -->|CÃ³| AddTempLowAlert[alerts.push<br/>Háº¡ nhiá»‡t: XÂ°C]
    CheckTempLow -->|KhÃ´ng| CheckTempHigh{Temp > 37Â°C?}
    AddTempLowAlert --> CheckTempHigh
    
    CheckTempHigh -->|CÃ³| AddTempHighAlert[alerts.push<br/>Nhiá»‡t Ä‘á»™ cao: XÂ°C]
    CheckTempHigh -->|KhÃ´ng| CheckAlertsLength{alerts.length<br/>> 0?}
    AddTempHighAlert --> CheckAlertsLength
    
    CheckAlertsLength -->|KhÃ´ng| NoAlert[KhÃ´ng cÃ³ cáº£nh bÃ¡o<br/>Táº¥t cáº£ bÃ¬nh thÆ°á»ng]
    NoAlert --> End2([Return])
    
    CheckAlertsLength -->|CÃ³| JoinAlerts[alertMessage =<br/>alerts.join | ]
    JoinAlerts --> SetMessage[setAlertMessage<br/>message]
    SetMessage --> ShowBanner[setShowAlert<br/>true]
    
    ShowBanner --> DisplayBanner[Hiá»ƒn thá»‹ alert banner:<br/>â€¢ Icon âš ï¸<br/>â€¢ Animation slide-in<br/>â€¢ Red background<br/>â€¢ Pulse effect]
    
    DisplayBanner --> SetTimeout[setTimeout 5000ms]
    SetTimeout --> AutoHide[setShowAlert false<br/>tá»± Ä‘á»™ng áº©n sau 5s]
    
    AutoHide --> End3([Return])
    
    style Start fill:#90EE90
    style CheckBPM fill:#FFA500
    style CheckSpO2 fill:#FFA500
    style CheckTempLow fill:#FFA500
    style CheckTempHigh fill:#FFA500
    style DisplayBanner fill:#FF6B6B
    style AutoHide fill:#98FB98
```

---

## 6. LÆ¯U Äá»’ Xá»¬ LÃ WEBSOCKET (Giáº£ láº­p)

```mermaid
flowchart TD
    Start([useEffect: Setup<br/>WebSocket connection]) --> CheckEnv{Is production<br/>environment?}
    
    CheckEnv -->|KhÃ´ng| UseSimulation[Sá»­ dá»¥ng dá»¯ liá»‡u<br/>giáº£ láº­p]
    CheckEnv -->|CÃ³| ConnectWS[Káº¿t ná»‘i WebSocket<br/>to sensor server]
    
    UseSimulation --> SetupSimulation[Setup giáº£ láº­p:<br/>â€¢ Random BPM: 60-100<br/>â€¢ Random SpO2: 95-100<br/>â€¢ Random Temp: 36-37]
    
    SetupSimulation --> SimulateData[HÃ m simulateData<br/>táº¡o giÃ¡ trá»‹ ngáº«u nhiÃªn]
    SimulateData --> SetInterval[setInterval 2000ms<br/>cáº­p nháº­t má»—i 2s]
    
    SetInterval --> GenerateRandom[Táº¡o giÃ¡ trá»‹ random:<br/>â€¢ bpm = 60 + rand*40<br/>â€¢ spo2 = 95 + rand*5<br/>â€¢ temp = 36 + rand*1]
    
    GenerateRandom --> UpdateRefs[Cáº­p nháº­t refs:<br/>â€¢ bpmRef.current<br/>â€¢ targetSpo2Ref<br/>â€¢ targetTempRef]
    
    UpdateRefs --> UpdateStates[Cáº­p nháº­t states:<br/>â€¢ setBpm<br/>â€¢ setSpo2<br/>â€¢ setTemperature]
    
    UpdateStates --> UpdateTimestamp[lastMessageTsRef<br/>= Date.now]
    UpdateTimestamp --> CheckConnection[Kiá»ƒm tra káº¿t ná»‘i<br/>timeout 5s]
    
    ConnectWS --> SetupWS[ws = new WebSocket<br/>url]
    SetupWS --> OnOpen[ws.onopen handler]
    OnOpen --> LogConnected[Console: ÄÃ£ káº¿t ná»‘i<br/>WebSocket]
    LogConnected --> SetStatus1[setConnectionStatus<br/>ÄÃ£ káº¿t ná»‘i cáº£m biáº¿n]
    
    SetStatus1 --> OnMessage[ws.onmessage handler]
    OnMessage --> ParseJSON[Parse JSON data:<br/>JSON.parse event.data]
    ParseJSON --> ExtractValues[Extract:<br/>â€¢ bpm<br/>â€¢ spo2<br/>â€¢ temperature]
    
    ExtractValues --> ValidateData{Data valid?}
    ValidateData -->|KhÃ´ng| LogError[Console error:<br/>Invalid data]
    ValidateData -->|CÃ³| UpdateFromWS[Update refs + states<br/>giá»‘ng nhÆ° simulation]
    
    UpdateFromWS --> UpdateTimestamp
    
    CheckConnection --> CheckTimeout{now - lastMessage<br/>> 5000ms?}
    CheckTimeout -->|KhÃ´ng| ConnectionOK[Káº¿t ná»‘i OK]
    CheckTimeout -->|CÃ³| DetectLoss[PhÃ¡t hiá»‡n máº¥t tÃ­n hiá»‡u]
    
    DetectLoss --> ResetValues[Reset values:<br/>â€¢ bpm = 0<br/>â€¢ baseline charts]
    ResetValues --> SetStatus2[setConnectionStatus<br/>Máº¥t tÃ­n hiá»‡u cáº£m biáº¿n]
    SetStatus2 --> ShowLossAlert[Show alert:<br/>Máº¥t tÃ­n hiá»‡u]
    
    ShowLossAlert --> ConnectionOK
    ConnectionOK --> LoopCheck[Loop kiá»ƒm tra<br/>má»—i 1s]
    LoopCheck --> CheckTimeout
    
    OnOpen --> OnError[ws.onerror handler]
    OnError --> LogWSError[Console error:<br/>WebSocket error]
    LogWSError --> SetStatus3[setConnectionStatus<br/>Lá»—i káº¿t ná»‘i]
    
    OnOpen --> OnClose[ws.onclose handler]
    OnClose --> LogClosed[Console: ÄÃ£ Ä‘Ã³ng<br/>káº¿t ná»‘i]
    LogClosed --> SetStatus4[setConnectionStatus<br/>ÄÃ£ ngáº¯t káº¿t ná»‘i]
    SetStatus4 --> Reconnect[Thá»­ káº¿t ná»‘i láº¡i<br/>sau 3s]
    Reconnect --> ConnectWS
    
    SetupSimulation --> Cleanup[Return cleanup function]
    SetupWS --> Cleanup
    
    Cleanup --> OnUnmount[Component unmount]
    OnUnmount --> ClearInterval[clearInterval<br/>simulation timer]
    ClearInterval --> CloseWS{WebSocket exists?}
    
    CloseWS -->|CÃ³| WSClose[ws.close]
    CloseWS -->|KhÃ´ng| End
    WSClose --> End([Cleanup complete])
    
    style Start fill:#90EE90
    style ConnectWS fill:#87CEEB
    style UseSimulation fill:#FFD700
    style UpdateStates fill:#98FB98
    style DetectLoss fill:#FF6B6B
    style End fill:#8B0000
```

---

## TÃ“M Táº®T CÃC LÆ¯U Äá»’

### ğŸ“Š LÆ°u Ä‘á»“ 1: Tá»•ng quan há»‡ thá»‘ng
- **Má»¥c Ä‘Ã­ch**: MÃ´ táº£ luá»“ng hoáº¡t Ä‘á»™ng tá»•ng thá»ƒ tá»« khá»Ÿi Ä‘á»™ng Ä‘áº¿n cÃ¡c chá»©c nÄƒng chÃ­nh
- **Äiá»ƒm chÃ­nh**: Firebase init â†’ Load data â†’ Render UI â†’ Handle user interactions

### ğŸ”€ LÆ°u Ä‘á»“ 2: Chá»n cháº¿ Ä‘á»™ sá»­ dá»¥ng
- **Má»¥c Ä‘Ã­ch**: PhÃ¢n biá»‡t Live Mode vs Historical Mode
- **Äiá»ƒm chÃ­nh**: Check ngÃ y â†’ Fetch data phÃ¹ há»£p â†’ Enable/disable features

### ğŸ’“ LÆ°u Ä‘á»“ 3: Äo BPM, SpO2, Nhiá»‡t Ä‘á»™
- **3.1 Äo BPM**: Animation sÃ³ng PPG + HRV + kiá»ƒm tra status
- **3.2 Äo SpO2**: LERP smooth + respiratory variation + alert
- **3.3 Äo Nhiá»‡t Ä‘á»™**: LERP cá»±c cháº­m + circadian rhythm + thermal variation
- **3.4 LÆ°u Firebase**: VÃ²ng láº·p 10s + throttle + validation
- **3.5 Chi tiáº¿t PPG**: TÃ­nh toÃ¡n sÃ³ng máº¡ch vá»›i systole, dicrotic notch
- **3.6 Chi tiáº¿t SpO2**: Smooth interpolation ká»¹ thuáº­t

### ğŸ“± LÆ°u Ä‘á»“ 4: ChÆ°Æ¡ng trÃ¬nh App
- **4.1 Lifecycle**: React component mount â†’ effects â†’ re-render â†’ unmount
- **4.2 Firebase Save**: Validation â†’ throttling â†’ arrayUnion â†’ status update
- **4.3 Excel Export**: Extract data â†’ format â†’ style â†’ download

### âš ï¸ LÆ°u Ä‘á»“ 5: Alert vÃ  cáº£nh bÃ¡o
- **Má»¥c Ä‘Ã­ch**: Kiá»ƒm tra ngÆ°á»¡ng â†’ hiá»ƒn thá»‹ cáº£nh bÃ¡o â†’ tá»± Ä‘á»™ng áº©n

### ğŸ”Œ LÆ°u Ä‘á»“ 6: WebSocket
- **Má»¥c Ä‘Ã­ch**: Káº¿t ná»‘i cáº£m biáº¿n (giáº£ láº­p) â†’ nháº­n data â†’ update UI â†’ detect loss

---

## CÃCH Äá»ŒC LÆ¯U Äá»’ TRÃŠN GITHUB

File nÃ y sá»­ dá»¥ng **Mermaid syntax**, Ä‘Æ°á»£c GitHub há»— trá»£ tá»± Ä‘á»™ng render.

### Xem trÃªn GitHub:
1. Push file nÃ y lÃªn repository
2. Má»Ÿ file trÃªn GitHub web interface
3. CÃ¡c lÆ°u Ä‘á»“ sáº½ tá»± Ä‘á»™ng hiá»ƒn thá»‹ dáº¡ng Ä‘á»“ há»a

### Xem local:
- **VS Code**: CÃ i extension "Markdown Preview Mermaid Support"
- **Browser**: Sá»­ dá»¥ng Mermaid Live Editor: https://mermaid.live/

---

## GHI CHÃš Ká»¸ THUáº¬T

### KÃ½ hiá»‡u mÃ u sáº¯c trong lÆ°u Ä‘á»“:
- ğŸŸ¢ **Xanh lÃ¡ nháº¡t**: Start/Input
- ğŸŸ¡ **VÃ ng**: Khá»Ÿi táº¡o/Setup
- ğŸ”µ **Xanh dÆ°Æ¡ng**: Processing/Calculation
- ğŸŸ£ **TÃ­m**: Database operations
- ğŸ”´ **Äá»**: Error/Stop/Alert
- ğŸŸ¢ **Xanh lÃ¡ Ä‘áº­m**: Success/End

### Quy Æ°á»›c Ä‘áº·t tÃªn:
- **camelCase**: Functions, variables
- **UPPER_CASE**: Constants
- **kebab-case**: Files, URLs

---

**TÃ i liá»‡u Ä‘Æ°á»£c táº¡o bá»Ÿi:** Äáº·ng VÄƒn Cáº¥y & Äá»— Äá»©c Duy  
**TrÆ°á»ng:** Äáº¡i há»c Giao thÃ´ng váº­n táº£i  
**NgÃ y:** 18/12/2025
chá»‰ sá»‘ sá»©c khá»e
- **3.1 Chá»n cháº¿ Ä‘á»™ Ä‘o**: Äo táº¥t cáº£ HOáº¶C Ä‘o riÃªng tá»«ng chá»‰ sá»‘ (BPM/SpO2/Nhiá»‡t Ä‘á»™)
- **3.2 Xá»­ lÃ½ dá»¯ liá»‡u**: WebSocket â†’ Animation (PPG/LERP smooth) â†’ Hiá»ƒn thá»‹ â†’ Check status
- **3.3 LÆ°u Firebase**: Throttle 10s â†’ LÆ°u vá»›i giÃ¡ trá»‹ 0 thÃ nh "-" trong Excel

### ğŸ“± LÆ°u Ä‘á»“ 4: ChÆ°Æ¡ng trÃ¬nh App
- **4.1 Lifecycle**: React component mount â†’ effects â†’ re-render â†’ unmount
- **4.2 Firebase Save**: Validation â†’ throttling â†’ arrayUnion â†’ status update
- **4.3 Excel Export**: Extract data â†’ format â†’ style â†’ download

### âš ï¸ LÆ°u Ä‘á»“ 5: Alert vÃ  cáº£nh bÃ¡o
- **Má»¥c Ä‘Ã­ch**: Kiá»ƒm tra ngÆ°á»¡ng â†’ hiá»ƒn thá»‹ cáº£nh bÃ¡o â†’ tá»± Ä‘á»™ng áº©n

### ğŸ”Œ LÆ°u Ä‘á»“ 6: WebSocket
- **Má»¥c Ä‘Ã­ch**: Káº¿t ná»‘i ESP32## TÃNH NÄ‚NG Äáº¶C BIá»†T

### ğŸ¯ Äo riÃªng láº» tá»«ng chá»‰ sá»‘
Há»‡ thá»‘ng há»— trá»£ 2 cháº¿ Ä‘á»™ Ä‘o:
1. **Äo táº¥t cáº£**: Báº¥m nÃºt "Báº¯t Ä‘áº§u Ä‘o" â†’ Ä‘o cáº£ 3 chá»‰ sá»‘
2. **Äo riÃªng láº»**: Báº¥m nÃºt "Äo" trÃªn tá»«ng card:
   - ğŸ’“ **Äo riÃªng BPM**: Chá»‰ lÆ°u nhá»‹p tim, SpO2 vÃ  Temp = 0 (hiá»ƒn thá»‹ "-" trong Excel)
   - ğŸ« **Äo riÃªng SpO2**: Chá»‰ lÆ°u oxy mÃ¡u, BPM vÃ  Temp = 0
   - ğŸŒ¡ï¸ **Äo riÃªng Nhiá»‡t Ä‘á»™**: Chá»‰ lÆ°u nhiá»‡t Ä‘á»™, BPM vÃ  SpO2 = 0
   - CÃ³ thá»ƒ Ä‘o káº¿t há»£p nhiá»u chá»‰ sá»‘ (vÃ­ dá»¥: BPM + Nhiá»‡t Ä‘á»™)

### ğŸ“Š Xuáº¥t Excel thÃ´ng minh
- GiÃ¡ trá»‹ = 0 hoáº·c khÃ´ng cÃ³ â†’ Hiá»ƒn thá»‹ **"-"** 
- Tráº¡ng thÃ¡i chá»‰ Ä‘Ã¡nh giÃ¡ cÃ¡c chá»‰ sá»‘ **cÃ³ giÃ¡ trá»‹ > 0**
- KhÃ´ng bÃ¡o lá»—i khi chÆ°a Ä‘o Ä‘á»§ 3 chá»‰ sá»‘

### ğŸ”„ Tráº¡ng thÃ¡i hiá»ƒn thá»‹ Ä‘á»™ng
- **Äang Ä‘o: Táº¥t cáº£** (khi Ä‘o tá»•ng)
- **Äang Ä‘o: ğŸ’“ BPM** (khi Ä‘o riÃªng BPM)
- **Äang Ä‘o: ğŸ« SpO2** (khi Ä‘o riÃªng SpO2)
- **Äang Ä‘o: ğŸŒ¡ï¸ Nhiá»‡t Ä‘á»™** (khi Ä‘o riÃªng nhiá»‡t Ä‘á»™)
- **Äang Ä‘o: ğŸ’“ BPM + ğŸŒ¡ï¸ Nhiá»‡t Ä‘á»™** (khi Ä‘o káº¿t há»£p)

---

**TÃ i liá»‡u Ä‘Æ°á»£c táº¡o bá»Ÿi:** Äáº·ng VÄƒn Cáº¥y & Äá»— Äá»©c Duy  
**TrÆ°á»ng:** Äáº¡i há»c Giao thÃ´ng váº­n táº£i  
**NgÃ y cáº­p nháº­t:** 18/12/2025  
**PhiÃªn báº£n:** 2.0 - ThÃªm tÃ­nh nÄƒng Ä‘o riÃªng láº»